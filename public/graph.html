<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <title>BⱯBEL RËVOLUㅏION</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>

    <link rel="icon" href="/img/icone-babel.png" type="image/png">

    <link rel="stylesheet" href="/style/style.css" type="text/css">
    <link rel="stylesheet" href="/style/graph.css" type="text/css">

  </head>

  <body onload="onLoadGraph()">

    <div id="container">

      <header id="graph_header">
        <div class="logo">
          <img onclick="window.location.href ='/'" src="\img\logoV2.png" alt="image" title="Revenir au menu principal">
        </div> 
      </header>

      <!-- switch french / english -->
      <select i18n-switch class="locale-switch">
        <option value="en">English</option>
        <option value="fr">Français</option>
      </select>
        
      <!-- about informations -->
      <div id="about">
        <button type="button" id="button-about-ouvert" onclick="OpenText()" i18n-key="button-about-ouvert">à propos +</button>
        <button type="button" id="button-about-ferme" onclick="OpenText()" style="display:none" i18n-key="button-about-ferme">à propos -</button>
        <div id="about-text" style="display:none" i18n-key="about-text"></div>
      </div>

      <!-- prologue : showed by onLoadGraph() in story.js  -->
      <div id="text-box-intro" style="display:none">
        <div id="intro" style="display:block">
          <div id="text">
            <h1 id="intro_title1" i18n-key="intro_title1"></h1>
            <div id="intro_page1" i18n-key="intro_page1"></div>
          </div>
          <button id="button-next" onclick="nextPageIntro('#intro', '#intro2')" i18n-key="button-next"></button>
        </div>
        <div id="intro2" style="display:none">
          <div id="text">
            <h1 id="intro_title2" i18n-key="intro_title2"></h1>
            <div id="intro_page2" i18n-key="intro_page2"></div>
          </div>
          <button id="button-next" onclick="nextPageIntro('#intro2', '#intro')" i18n-key="button-back"></button>
          <button id="button-next" onclick="nextPageIntro('#intro2', '#intro3')" i18n-key="button-next"></button>
        </div>
        <div id="intro3" style="display:none">
          <div id="text">
            <h1 id="intro_title3" i18n-key="intro_title3"></h1>
            <div id="intro_page3" i18n-key="intro_page3"></div>
          </div>
          <button id="button-next" onclick="nextPageIntro('#intro3', '#intro2')" i18n-key="button-back"></button>
          <button id="button-next" onclick="EnterWorld()" i18n-key="enter-world"></button>
        </div>

        <div id="load" style="display:none">
          <svg class="loader" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 340 340">
            <circle cx="170" cy="170" r="160" stroke="#f2f2f2"/>
            <circle cx="170" cy="170" r="135" stroke="#404041"/>
            <circle cx="170" cy="170" r="110" stroke="#f2f2f2"/>
            <circle cx="170" cy="170" r="85" stroke="#404041"/>
        </svg>
        </div>
      </div>

      <!-- prologue : showed by onLoadGraph() in story.js  -->
      <div id="main" style="display:none">
        <div id="graph"></div>
        <dialog id="session_dialog">
          <button type="button" class="close">X</button>
          <h3 id="dialog_type"></h3>
          <h2 id="dialog_title"></h2>
          <p id="dialog_text"></p>
          <div id="dialog_examples">
            <!-- The examples are added by graph-admin.js -->
          </div>
        </dialog>

          <div id="text-box" style="display:flex"> <!-- right zone-->
            <div id="messages">
              <h3 class="title-with-toggle" onclick="toggle('span-toggle-messages', 'messages-inside')"><span i18n-key="messages"></span> <span id="span-toggle-messages" class="arrow-toggle">⇩</span></h3>
              <div id="messages-inside" style="display:none">
                <h3 class="title-with-toggle" id="title-form" onclick="toggle('span-toggle-writing', 'add-node-form')"><span i18n-key="write-messages"></span> <span id="span-toggle-writing" class="arrow-toggle">⇩</span></h3>
                <form id="add-node-form" style="display:none">
                  <input required id="add-node-title" class="input" type="text" style="font-style:italic">
                  <input required id="add-node-author" class="input" type="text" style="font-style:italic">
                  <label i18n-key="in-reaction-to"></label>
                  <select id="add-node-react" class="input">
                    <!-- options added for each decree in src/app.js-->
                  </select>
                  <label i18n-key="belief"></label>
                  <select id="add-node-belief" class="input">
                    <option value="against" selected i18n-key="belief-against"></option>
                    <option value="neutral" i18n-key="belief-neutral"></option>
                    <option value="in_favor" i18n-key="belief-in-favor"></option>
                  </select>
                  <textarea required id="add-node-text" class="input" type="text" style="font-style:italic;"></textarea>
                  <input id="add-node-type" class="input" type="hidden" value="contribution">
                  <button id="add-node-button" type="submit" i18n-key="publish-title"></button>
                </form>

                <div id="node-info">
                  <h4><div id="node-title"></div></h4> 
                  <h5><span i18n-key='written-by' id="written-by" style="display: none;"></span> <div id="node-author"></div></h5>
                  <div id="node-text"></div>
                </div>

              </div>
              
            </div>

          </div>

          <div id="toggle-titles">
            <h6 id="title_for_toggle" i18n-key="title_for_toggle"></h6>
            <label class="switch">
              <input type="checkbox" id="toggle_checkbox" checked>
              <span class="slider round"></span>
            </label>
          </div>

          <h6 id="title_for_zoom" i18n-key="title_for_zoom"></h6>
          <div id="zoom">
            <span id="zoom-minus">–</span><span id="zoom-plus">+</span>
          </div>


      </div>




    </div>

    <script type=module src="/src/app.js"></script>
    <script src="/src/story.js"></script>
    <script src="/src/interface.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/src/i18n.js"></script>
    <script type="module">
      import {updateGraph} from "/src/app.js";
      import {getLabelSelection} from "/src/app.js"

      let ended = false;
      const sessionDialog = document.querySelector('dialog#session_dialog');
      const socket = io();
      const form = document.getElementById('add-node-form');
      
      //toggle to show or hide label
      const toggle = document.querySelector('#toggle-titles');
      toggle.addEventListener('click', () => {
        let labelSelection = getLabelSelection()
        if(document.getElementById('toggle_checkbox').checked) {
          labelSelection.style('opacity', 1)
        } else {
          labelSelection.style('opacity', 0)
        }
      })

      form.addEventListener('submit', function() {
        socket.emit('databaseUpdate');
      });

      socket.on('databaseUpdate', async function(){
        await updateGraph();
      });

      //dialog from the new decree
      socket.on('decreePublished', async function (decreeAndExamples) {
        // We add the decree type, title and text
        sessionDialog.querySelector('#dialog_type').textContent = null; //null because the langague can't be changed
        sessionDialog.querySelector('#dialog_title').textContent = decreeAndExamples.decree.title;
        sessionDialog.querySelector('#dialog_text').textContent = decreeAndExamples.decree.text;
  
        // We show the dialog
        sessionDialog.showModal();
        // We update the graph
        await updateGraph();
      });

      // The event 'sessionCompleted' is received when the session ends
      socket.on('sessionCompleted', async function (end) {
        // We add the decree title and text
        sessionDialog.querySelector('#dialog_type').textContent = null;
        sessionDialog.querySelector('#dialog_title').textContent = end.title;
        sessionDialog.querySelector('#dialog_text').textContent = end.text;
        // We delete the examples
        sessionDialog.querySelector('div#dialog_examples').innerHTML = '';
        document.getElementById('add-node-form').style.display = "none"; //hide the form after the end
        document.getElementById('title-form').style.display = "none"; //hide the form after the end
        // We show the dialog
        sessionDialog.showModal();
        // Redirect to this page but in visualisation mode
        ended = true;
      });

      sessionDialog.querySelector('button.close').addEventListener('click', () => {
        sessionDialog.close();
        if (ended) {
          form.disabled = true;
        }
      });

    </script>
    <script>
      function OpenText() { 
        var btnferme = document.getElementById("button-about-ouvert");
        var moreText = document.getElementById("about-text");
        var btnouvert = document.getElementById("button-about-ferme");
      
        //same function in interface.js (toggle_simple)
        if (btnferme.style.display === "none") {
          btnferme.style.display = "block";
          moreText.style.display = "none";
          btnouvert.style.display = "none";
        } else {
          btnferme.style.display = "none";
          moreText.style.display = "block";
          btnouvert.style.display = "block";
        }
      }
    </script>
    <script>
      function addEvent(a,b,c,d) {
        a.addEventListener?a.addEventListener(b,c,d||!1):a.attachEvent('on'+b,c);
      }
      
      //to fix
      function changeZoom(zoom, e) {
        currentZoom += coefficient * (e.detail < 0 || e.wheelDelta > 0 || zoom > 0 ? 1 : -1);
        currentZoom < 0 && (currentZoom = 0); 
        transform && (zoomArea.style[transform] = "scale("+ (currentZoom) +")");
        ("zoom" in document.body.style && !transform) && (zoomArea.style.zoom = currentZoom);
      }

      let zoomArea = document.querySelector("#graph"),
      currentZoom = 1,
      coefficient = .2,
      transform;

    if ("transform" in document.body.style) {
      transform = "transform";
    }else {
      for (var p in document.body.style) {
        if (/^((Moz|(?:w|W)ebkit|ms|o)Transform)/.exec(p)) {
          transform = RegExp.$1;
          break;
        }
      }
    }

    addEvent(document.getElementById("zoom-plus"), "click", function(e){changeZoom(1, e)});
    addEvent(document.getElementById("zoom-minus"), "click", function(e){changeZoom(-1, e)});
    </script>
    <script>
      function EnterWorld() {
        document.getElementById("intro3").style.display = "none";
        document.getElementById("load").style.display = "block";
        setTimeout(() => {document.getElementById("text-box-intro").style.display = "none"; window.location.href = window.location.href.split("?")[0];}, 2000);
      }
    </script>
    </body>
 </html>